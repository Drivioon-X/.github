---
name: Publish DockerHub (reusable)

on:
  workflow_call:
    inputs:
      csproj_file:
        description: "Ruta al .csproj bajo /src (por ejemplo: www.dinaup.com/wwwdinaupcom.csproj)"
        required: true
        type: string
      docker_image:
        description: "Nombre del repo en Docker Hub (sin usuario). Ej.: www.dinaup.com"
        required: true
        type: string
      dockerfile:
        description: "Ruta al Dockerfile"
        required: false
        default: ./Dockerfile
        type: string
      context:
        description: "Directorio de build context"
        required: false
        default: .
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
      DOCKERHUB_TOKEN:
        required: true

jobs:
  docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - uses: actions/checkout@v4

      - name: Read version & prepare tags
        id: ver
        shell: bash
        run: |
          set -euo pipefail

          FILE="src/${{ inputs.csproj_file }}"
          if [ ! -f "$FILE" ]; then
            echo "❌ No existe ${FILE}. Pasa 'inputs.csproj_file' con la ruta al .csproj (relativa a /src)" >&2
            exit 1
          fi

          VERSION=$(grep -oPm1 '(?<=<Version>)[^<]+' "$FILE" || true)
          if [ -z "$VERSION" ]; then
            echo "❌ No se encontró <Version> en $FILE" >&2
            exit 1
          fi

          # Obtener nombre de rama: prefer GITHUB_REF_NAME, si no existe usar git
          if [ -n "${GITHUB_REF_NAME:-}" ]; then
            RAW_BRANCH="$GITHUB_REF_NAME"
          else
            RAW_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo unknown)"
          fi

          # Normaliza: reemplaza / por - y pasa a minúsculas
          BRANCH="$(echo "${RAW_BRANCH//\//-}" | tr '[:upper:]' '[:lower:]')"

          IMAGE="docker.io/${{ secrets.DOCKERHUB_USERNAME }}/${{ inputs.docker_image }}"

          tags=()

          # Ramas principales no llevan sufijo; el resto sí (evita tags con /).
          if [ "${BRANCH}" = "main" ] || [ "${BRANCH}" = "master" ]; then
            tags+=("${IMAGE}:latest")
            tags+=("${IMAGE}:${VERSION}")
          else
            tags+=("${IMAGE}:latest-${BRANCH}")
            tags+=("${IMAGE}:${VERSION}-${BRANCH}")
          fi

          # Exportar salida para GitHub Actions
          {
            echo 'tags<<EOF'
            printf '%s\n' "${tags[@]}"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.dockerfile }}
          push: true
          tags: ${{ steps.ver.outputs.tags }}
